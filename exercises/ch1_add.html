<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lesson 1 ‚Äî add(a,b)</title>

  <link rel="stylesheet" href="../assets/styles.css">
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.6.1/core.js"></script>
  <script defer src="../assets/app.js"></script>
</head>
<body>
  <div class="card">
    <a href="../index.html">‚Üê Back</a>

    <img class="peter-hero" src="../assets/img/peter-lesson1.webp" alt="Peter the Python at a laptop">

    <h1>Lesson 1: add(a,b)</h1>

    <div class="learnbox">
      <h4>Why this?</h4>
      <ul class="kids-list">
        <li>A <b>function</b> is a named trick. Teach Peter once; he can do it forever.</li>
      </ul>
      <h4>What you‚Äôll type</h4>
      <ul class="kids-list">
        <li>Make <code>add(a, b)</code> that gives the answer back. <b>Printing</b> is okay for now; <b>return</b> is the pro way.</li>
      </ul>
      <h4>New words & symbols</h4>
      <div><span class="glossy">return</span> give back ‚Ä¢ <span class="glossy">()</span> hands that hold the numbers</div>
      <h4>Common oopsies</h4>
      <ul class="kids-list">
        <li>Only printing inside the function (works here, but later we‚Äôll use <code>return</code>).</li>
        <li>Forgetting the colon <code>:</code> or indentation.</li>
      </ul>
    </div>

    <div class="hud">
      <div id="stars" class="badge">‚≠ê Stars: 0</div>
      <div id="bugs" class="badge bug">üêû Bugs: 0</div>
    </div>

    <div class="toolbar">
      <button id="starter" class="btn ghost" type="button">Insert Starter</button>
      <button id="hintBtn" class="btn ghost" type="button">Show Hint</button>
      <button id="solBtn" class="btn ghost" type="button">Show Solution</button>
    </div>

    <textarea id="editor" class="editor" placeholder="# Make add(a, b). Print OR return a+b."></textarea>

    <p>
      <button id="run" class="btn" type="button">Run ‚ñ∂</button>
      <a class="btn ghost" href="ch2_gems.html">Next Lesson ‚Üí</a>
    </p>
    <pre id="out"></pre>

    <details id="hint" style="display:none"><summary>Hint</summary>
      <div class="small">Start with <code>def add(a, b):</code> then either <code>print(a+b)</code> or <code>return a+b</code>.</div>
    </details>
    <details id="sol" style="display:none"><summary>Solution (peek only)</summary>
      <pre>def add(a, b):
    return a + b</pre>
    </details>
  </div>

  <script type="py">
from js import document, localStorage, window
from pyodide.ffi import create_proxy
import io, sys

STARTER = "def add(a, b):\n    # print(a+b)  # OK for now\n    # return a + b  # pro way\n    pass\n"

class Capture:
    def __enter__(self):
        self._old = sys.stdout
        self.buf = io.StringIO()
        sys.stdout = self.buf
        return self.buf
    def __exit__(self, *args):
        sys.stdout = self._old

def gi(k):
    v = localStorage.getItem(k)
    try: return int(v) if v is not None else 0
    except: return 0

def setb(stars=None, bugs=None):
    if stars is not None: localStorage.setItem('stars', str(stars))
    if bugs  is not None: localStorage.setItem('bugs',  str(bugs))
    document.getElementById('stars').textContent = f"‚≠ê Stars: {gi('stars')}"
    document.getElementById('bugs').textContent  = f"üêû Bugs: {gi('bugs')}"

def insert_starter(evt):
    document.getElementById('editor').value = STARTER

def toggle_hint(evt):
    h = document.getElementById('hint')
    h.style.display = 'block' if h.style.display == 'none' else 'none'

def toggle_sol(evt):
    s = document.getElementById('sol')
    s.style.display = 'block' if s.style.display == 'none' else 'none'

def ok_result_or_print(f, a, b, want):
    # Accept either returned value OR printed value
    with Capture() as cap:
        res = f(a,b)
    out = cap.getvalue().strip()
    # Look for the number in the printed output
    printed_ok = str(want) in out.replace(',', ' ').split()
    returned_ok = (res == want)
    return printed_ok or returned_ok

def run(evt):
    src = document.getElementById('editor').value
    if not src.strip():
        document.getElementById('out').textContent = "Type your code first üôÇ"
        return
    if "pass" in src:
        document.getElementById('out').textContent = "Replace 'pass' with working code."
        return
    ns = {}
    try:
        exec(src, ns)
        assert 'add' in ns, "Function 'add' is missing."
        f = ns['add']
        assert ok_result_or_print(f, 2, 3, 5), "add(2,3) should be 5."
        assert ok_result_or_print(f, -1, 1, 0), "add(-1,1) should be 0."
        document.getElementById('out').textContent = "All checks passed! ‚≠ê"
        setb(stars=gi('stars')+1)
        window.launchConfetti()
        # Coach toward 'return'
        if "return" not in src:
            document.getElementById('out').textContent += " (Great! Next try using return.)"
    except Exception as e:
        document.getElementById('out').textContent = "Bug found: " + str(e)
        setb(bugs=gi('bugs')+1)

# Ctrl+Enter shortcut
def on_key(evt):
    if evt.ctrlKey and evt.key == "Enter":
        run(evt)
document.getElementById('editor').addEventListener('keydown', create_proxy(on_key))

document.getElementById('starter').addEventListener('click', create_proxy(insert_starter))
document.getElementById('hintBtn').addEventListener('click', create_proxy(toggle_hint))
document.getElementById('solBtn').addEventListener('click', create_proxy(toggle_sol))
document.getElementById('run').addEventListener('click', create_proxy(run))
setb()
  </script>
</body>
</html>
